@page "/edit-recipe/{id:int}"
@inject Services.IRecipeService RecipeService
@inject NavigationManager NavigationManager
@using ODBlazorApp.Models

@if (recipe == null)
{
    <div class="container mt-5 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-3">Chargement de la recette...</p>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="display-6 fw-bold text-primary">
                        <i class="bi bi-pencil-square me-2"></i>Modifier la recette
                    </h1>
                    <div>
                        <a href="/recipe/@recipe.Id" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-eye me-1"></i>Voir
                        </a>
                        <button class="btn btn-danger" @onclick="DeleteRecipe">
                            <i class="bi bi-trash me-1"></i>Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <EditForm Model="@recipe" OnValidSubmit="@HandleSubmit" FormName="editRecipeForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="row">
                <div class="col-lg-8">
                    <!-- Informations principales -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Informations principales</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="form-floating mb-3">
                                        <InputText id="title" class="form-control" @bind-Value="recipe.Title" />
                                        <label for="title">Titre de la recette *</label>
                                        <ValidationMessage For="@(() => recipe.Title)" />
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        <InputSelect id="category" class="form-select" @bind-Value="recipe.Category">
                                            <option value="">Choisir une catégorie</option>
                                            @if (availableCategories != null)
                                            {
                                                @foreach (var category in availableCategories)
                                                {
                                                    <option value="@category">@category</option>
                                                }
                                            }
                                            <option value="Autre">Autre</option>
                                        </InputSelect>
                                        <label for="category">Catégorie *</label>
                                        <ValidationMessage For="@(() => recipe.Category)" />
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <InputTextArea id="description" class="form-control"
                                                       @bind-Value="recipe.Description"
                                                       style="height: 100px;" />
                                        <label for="description">Description</label>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        <InputNumber id="prepTime" class="form-control"
                                                     @bind-Value="recipe.PreparationTime" />
                                        <label for="prepTime">Temps préparation (min) *</label>
                                        <ValidationMessage For="@(() => recipe.PreparationTime)" />
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        <InputNumber id="cookTime" class="form-control"
                                                     @bind-Value="recipe.CookingTime" />
                                        <label for="cookTime">Temps cuisson (min)</label>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating mb-3">
                                        <InputSelect id="difficulty" class="form-select"
                                                     @bind-Value="recipe.Difficulty">
                                            <option value="Facile">Facile</option>
                                            <option value="Moyen">Moyen</option>
                                            <option value="Difficile">Difficile</option>
                                        </InputSelect>
                                        <label for="difficulty">Difficulté</label>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <InputNumber id="servings" class="form-control"
                                                     @bind-Value="recipe.Servings" />
                                        <label for="servings">Nombre de personnes *</label>
                                        <ValidationMessage For="@(() => recipe.Servings)" />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <InputText id="imageUrl" class="form-control"
                                                   @bind-Value="recipe.ImageUrl" />
                                        <label for="imageUrl">URL de l'image</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ingrédients -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Ingrédients</h5>
                                <button type="button" class="btn btn-light btn-sm" @onclick="AddIngredient">
                                    <i class="bi bi-plus"></i> Ajouter
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @for (int i = 0; i < recipe.Ingredients.Count; i++)
                            {
                                var index = i;
                                <div class="row g-2 mb-3 align-items-center">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" placeholder="Nom de l'ingrédient"
                                               @bind="recipe.Ingredients[index].Name"
                                               @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" step="0.01" class="form-control" placeholder="Quantité"
                                               @bind="recipe.Ingredients[index].Quantity"
                                               @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" @bind="recipe.Ingredients[index].Unit">
                                            <option value="">Unité</option>
                                            <option value="g">g</option>
                                            <option value="kg">kg</option>
                                            <option value="ml">ml</option>
                                            <option value="L">L</option>
                                            <option value="c.à.s">c.à.s</option>
                                            <option value="c.à.c">c.à.c</option>
                                            <option value="pincée">pincée</option>
                                            <option value="unité">unité</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="Notes"
                                               @bind="recipe.Ingredients[index].Notes"
                                               @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-1">
                                        @if (recipe.Ingredients.Count > 1)
                                        {
                                            <button type="button" class="btn btn-danger btn-sm"
                                                    @onclick="() => RemoveIngredient(index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Étapes -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>Étapes de préparation</h5>
                                <button type="button" class="btn btn-light btn-sm" @onclick="AddStep">
                                    <i class="bi bi-plus"></i> Ajouter
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @for (int i = 0; i < recipe.Steps.Count; i++)
                            {
                                var step = recipe.Steps[i];
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Étape @(i + 1)</label>
                                    <div class="input-group">
                                        <textarea class="form-control" rows="2"
                                                  @bind="step.Description"
                                                  @bind:event="oninput"></textarea>
                                        @if (recipe.Steps.Count > 1)
                                        {
                                            <button type="button" class="btn btn-outline-danger"
                                                    @onclick="() => RemoveStep(i)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Tags</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="tagsInput"
                                       @bind="tagsInput" @bind:event="oninput"
                                       placeholder="Séparés par des virgules" />
                                <label for="tagsInput">Tags (séparés par des virgules)</label>
                            </div>
                            @if (recipe.Tags.Any())
                            {
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var tag in recipe.Tags)
                                    {
                                        <span class="badge bg-primary">@tag.Name</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="d-flex justify-content-between mb-5">
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">
                            <i class="bi bi-x-circle me-1"></i>Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Enregistrer les modifications
                        </button>
                    </div>
                </div>

                <!-- Historique des modifications -->
                <div class="col-lg-4">
                    <div class="sticky-top" style="top: 20px;">
                        <div class="card shadow-sm mb-3">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historique</h6>
                            </div>
                            <div class="card-body">
                                <p class="small mb-1">
                                    <strong>Créée le :</strong>
                                    @recipe.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                </p>
                                <p class="small mb-0">
                                    <strong>Dernière modification :</strong>
                                    @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                                </p>
                            </div>
                        </div>

                        <!-- Aperçu rapide -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-eye me-2"></i>Aperçu rapide</h6>
                            </div>
                            <div class="card-body">
                                <h5>@recipe.Title</h5>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge bg-primary">@recipe.Category</span>
                                    <span class="badge @GetDifficultyBadgeClass()">@recipe.Difficulty</span>
                                </div>
                                <div class="small text-muted">
                                    @recipe.Ingredients.Count ingrédients • @recipe.Steps.Count étapes
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private Recipe? recipe;
    private List<string>? availableCategories;
    private string tagsInput = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        recipe = await RecipeService.GetRecipeByIdAsync(Id);
        if (recipe == null)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            availableCategories = await RecipeService.GetCategoriesAsync();
            tagsInput = string.Join(", ", recipe.Tags.Select(t => t.Name));
        }
    }

    private void AddIngredient()
    {
        recipe?.Ingredients.Add(new Ingredient());
    }

    private void RemoveIngredient(int index)
    {
        if (recipe != null && recipe.Ingredients.Count > 1)
        {
            recipe.Ingredients.RemoveAt(index);
        }
    }

    private void AddStep()
    {
        recipe?.Steps.Add(new RecipeStep { StepNumber = recipe.Steps.Count + 1 });
    }

    private void RemoveStep(int index)
    {
        if (recipe != null && recipe.Steps.Count > 1)
        {
            recipe.Steps.RemoveAt(index);
            // Reorganiser les numéros d'étapes
            for (int i = 0; i < recipe.Steps.Count; i++)
            {
                recipe.Steps[i].StepNumber = i + 1;
            }
        }
    }

    private async Task HandleSubmit()
    {
        if (recipe != null)
        {
            // Gérer les tags
            if (!string.IsNullOrWhiteSpace(tagsInput))
            {
                recipe.Tags = tagsInput.Split(',')
                    .Select(t => t.Trim())
                    .Where(t => !string.IsNullOrWhiteSpace(t))
                    .Select(t => new Tag { Name = t })
                    .ToList();
            }

            await RecipeService.UpdateRecipeAsync(recipe);
            NavigationManager.NavigateTo($"/recipe/{recipe.Id}");
        }
    }

    private void CancelEdit()
    {
        NavigationManager.NavigateTo($"/recipe/{Id}");
    }

    private async Task DeleteRecipe()
    {
        if (recipe != null)
        {
            await RecipeService.DeleteRecipeAsync(recipe.Id);
            NavigationManager.NavigateTo("/");
        }
    }

    private string GetDifficultyBadgeClass()
    {
        if (recipe == null) return "bg-secondary";

        return recipe.Difficulty switch
        {
            DifficultyLevel.Facile => "bg-success",
            DifficultyLevel.Moyen => "bg-warning",
            DifficultyLevel.Difficile => "bg-danger",
            _ => "bg-secondary"
        };
    }
}